<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: preload/fs/fsAPICalls.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: preload/fs/fsAPICalls.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const fs = require('fs');
const {ipcRenderer} = require('electron');
const path = require('path');
const {debugLog} = require('../general/genAPICalls');

let storagePath = '';

/**
 * @description MUST BE CALLED ON STARTUP. Sets the path to userData, which can
 * only be done from main.js.
 * @return {Promise&lt;void>}
 */
async function fsInit() {
	storagePath = await ipcRenderer.invoke('getUserData');
	storagePath = path.join(storagePath, 'MixMatch');
	await makeDirIfNotExists(storagePath);
	await debugLog('UserData Storage Path: ' + storagePath, 'fs-general');
}

/**
 *
 * @param {string} newStoragePath
 * @return {Promise&lt;void>}
 */
async function setStoragePath(newStoragePath) {
	const localPath = await getSourceFolder();
	storagePath = path.join(localPath, newStoragePath);
	await makeDirIfNotExists(storagePath);
	await debugLog('UserData Storage Path: ' + storagePath, 'fs-general');
}

/**
 *
 * @return {Promise&lt;string>}
 */
async function getStoragePath() {
	return storagePath;
}

/**
 *
 * @return {Promise&lt;string>}
 */
async function getSourceFolder() {
	return __dirname + '/../../..';
}

/**
 * @name devClear
 * @description Deletes every file. Useful for development and unit tests.
 *              Can only be called from whitelisted callers.
 * @memberOf fsAPI
 * @param {object} caller A reference to the caller. This function can only be
 *                      called from whitelisted callers.
 * @return {Promise&lt;void>}
 */
async function devClear(caller) {
	const settingPath = path.join(storagePath, 'settings.json');
	const songsPath = path.join(storagePath, 'songs.json');
	const statsPath = path.join(storagePath, 'stats.json');
	const playlistPath = path.join(storagePath, 'playlists');

	if (fs.existsSync(settingPath)) {
		fs.rmSync(settingPath);
	}
	if (fs.existsSync(songsPath)) {
		fs.rmSync(songsPath);
	}
	if (fs.existsSync(statsPath)) {
		fs.rmSync(statsPath);
	}
	if (fs.existsSync(playlistPath)) {
		fs.rmdirSync(playlistPath, {recursive: true});
	}
}

/* File Structure in userData
.../MixMatch
    |-- playlists
    |   |-- myPlaylist.mmp
    |-- lyrics
    |   |-- myLyrics.(?)
    |-- settings.json
    |-- songs.json
    |-- stats.json
 */

/**
 * @name makeDirIfExists
 * @description Checks if a folder, and if not creates it.
 * @memberOf fsAPI
 * @param {string} folder The folder to be checked for.
 * @return {Promise&lt;void>}
 */
async function makeDirIfNotExists(folder) {
	await fs.opendir(folder, async (err, dir) => {
		if (err) {
			await fs.mkdir(folder, {recursive: false}, () => {
				// Any callback that needs to happen on first folder create
				// can happen here.
			});
		}
	});
}

/**
 * @name getSRCString
 * @description Gets a string that, when passed into the src of a HTML Audio
 * element will play the sound.
 * @memberOf fsAPI
 * @param {string} path The path to an audio file on the computer
 * @return {Promise&lt;string>} A HTML Audio compatible src string.
 * @todo May not work on all (or any) OS! May need to give filesystem access!
 */
async function getSRCString(path) {
	return 'file:///' + path;
}

// To future people trying to make recursiveSearchAtPath async: don't. seriously. it isn't worth the headache.

/**
 * @name recursiveSearchAtPath
 * @description Recursively searches every subdirectory at a given directory
 * to return every song.
 * @memberOf fsAPI
 * @param {string} searchPath The pat at which to recursively search
 * @return {Promise&lt;string[]>}  An array of every song path that exists recursively
 * within the directory.
 *
 */
async function recursiveSearchAtPath(searchPath) {
	// try and catch to take care of illegal folders/files
	try {
		const ret = [];
		const dirs = fs.readdirSync(
			searchPath,
			{withFileTypes: true},
		).filter((d) => d.isDirectory()).map((d) => d.name);

		for (const dir of dirs) {
			const dirPath = path.join(searchPath, dir);
			if (fs.existsSync(dirPath)) {
				const paths = await recursiveSearchAtPath(dirPath);
				paths.forEach((p) => ret.push(p));
			}
		}

		const files = fs.readdirSync(
			searchPath,
			{withFileTypes: true},
		).filter((d) =>
			d.isFile()).filter((d) =>
			d.name.split('.').pop() === 'mp3').map((d) => d.name);
		files.forEach((f) => ret.push(path.join(searchPath, f).split(path.sep).join(path.posix.sep)));

		return ret;
	} catch (e) {
		console.log(e);
		return [];
	}
}

module.exports = {
	getStoragePath,
	makeDirIfNotExists,
	getSRCString,
	fsInit,
	devClear,
	recursiveSearchAtPath,
	setStoragePath,
	getSourceFolder,
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Namespaces</h3><ul><li><a href="domAPI.html">domAPI</a></li><li><a href="ffmpegAPI.html">ffmpegAPI</a></li><li><a href="fsAPI.html">fsAPI</a></li><li><a href="genAPI.html">genAPI</a></li></ul><h3>Global</h3><ul><li><a href="global.html#addGrid">addGrid</a></li><li><a href="global.html#addPath">addPath</a></li><li><a href="global.html#addToPlaylist">addToPlaylist</a></li><li><a href="global.html#appendSongs">appendSongs</a></li><li><a href="global.html#createMultiFFmpegPromise">createMultiFFmpegPromise</a></li><li><a href="global.html#createPlaylist">createPlaylist</a></li><li><a href="global.html#editMetaData">editMetaData</a></li><li><a href="global.html#enabledTags">enabledTags</a></li><li><a href="global.html#eventHandlerLoadPhase">eventHandlerLoadPhase</a></li><li><a href="global.html#ffmpegReadPromise">ffmpegReadPromise</a></li><li><a href="global.html#findCategories">findCategories</a></li><li><a href="global.html#fsInit">fsInit</a></li><li><a href="global.html#getFile">getFile</a></li><li><a href="global.html#getMultiCMD">getMultiCMD</a></li><li><a href="global.html#getReadCMD">getReadCMD</a></li><li><a href="global.html#getReadCMDForSpawn">getReadCMDForSpawn</a></li><li><a href="global.html#getSourceFolder">getSourceFolder</a></li><li><a href="global.html#getStoragePath">getStoragePath</a></li><li><a href="global.html#getWriteCMD">getWriteCMD</a></li><li><a href="global.html#homeClick">homeClick</a></li><li><a href="global.html#htmlFromRenderer">htmlFromRenderer</a></li><li><a href="global.html#libraryAlbumsClick">libraryAlbumsClick</a></li><li><a href="global.html#libraryArtistsClick">libraryArtistsClick</a></li><li><a href="global.html#libraryClick">libraryClick</a></li><li><a href="global.html#libraryGenresClick">libraryGenresClick</a></li><li><a href="global.html#libraryTagsClick">libraryTagsClick</a></li><li><a href="global.html#onLibraryLoad">onLibraryLoad</a></li><li><a href="global.html#overviewClick">overviewClick</a></li><li><a href="global.html#ovExLyricsClick">ovExLyricsClick</a></li><li><a href="global.html#ovExQueueClick">ovExQueueClick</a></li><li><a href="global.html#ovExTrackClick">ovExTrackClick</a></li><li><a href="global.html#playlistsClick">playlistsClick</a></li><li><a href="global.html#postInit">postInit</a></li><li><a href="global.html#postLibraryLoad">postLibraryLoad</a></li><li><a href="global.html#removeTempFile">removeTempFile</a></li><li><a href="global.html#rescanClick">rescanClick</a></li><li><a href="global.html#searchAlbumsClick">searchAlbumsClick</a></li><li><a href="global.html#searchAllClick">searchAllClick</a></li><li><a href="global.html#searchArtistsClick">searchArtistsClick</a></li><li><a href="global.html#searchGenresClick">searchGenresClick</a></li><li><a href="global.html#searchPlaylistsClick">searchPlaylistsClick</a></li><li><a href="global.html#searchTagsClick">searchTagsClick</a></li><li><a href="global.html#searchTracksClick">searchTracksClick</a></li><li><a href="global.html#setStoragePath">setStoragePath</a></li><li><a href="global.html#settingsClick">settingsClick</a></li><li><a href="global.html#submitSearch">submitSearch</a></li><li><a href="global.html#testAll">testAll</a></li><li><a href="global.html#testDeleteSetting">testDeleteSetting</a></li><li><a href="global.html#testGetSettings">testGetSettings</a></li><li><a href="global.html#testSettings">testSettings</a></li><li><a href="global.html#testSongs">testSongs</a></li><li><a href="global.html#testWriteSettings">testWriteSettings</a></li><li><a href="global.html#testWriteToSetting">testWriteToSetting</a></li><li><a href="global.html#topExtensionOff">topExtensionOff</a></li><li><a href="global.html#topExtensionOn">topExtensionOn</a></li><li><a href="global.html#useMultiFFmpeg">useMultiFFmpeg</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.11</a> on Tue Nov 15 2022 12:54:15 GMT-0800 (Pacific Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
